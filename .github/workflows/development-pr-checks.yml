name: Reusable - Development PR Comprehensive Checks

on:
  workflow_call:
    inputs:
      node-version:
        description: "Node.js version"
        required: false
        default: "22"
        type: string
      service-name:
        description: "Service name for Codecov flag"
        required: true
        type: string
    secrets:
      SDK_TOKEN:
        required: true
      CODECOV_TOKEN:
        required: true
      COMMON_TOKEN:
        required: true

jobs:
  pr-tests:
    name: PR Coverage Job
    runs-on: ubuntu-latest
    outputs:
      pr_coverage_file: pr-coverage-summary.json
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.COMMON_TOKEN }}
          submodules: recursive
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: npm

      - name: Configure npm private registry
        run: |
          echo "@habuildserver:registry=https://npm.pkg.github.com/" >> ~/.npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.SDK_TOKEN }}" >> ~/.npmrc

      - run: npm ci

      # ---- Linting + Formatting ----
      - name: Run linting
        run: npm run lint:check

      - name: Check code formatting
        run: |
          npm run format
          if ! git diff --quiet; then
            echo "âŒ Code formatting required. Run npm run format."
            git diff
            exit 1
          fi
          echo "Formatting OK."

      # ---- PR Test Coverage ----
      - name: Run PR coverage
        id: test_pr
        run: npm run test:cov

      - name: Save PR coverage
        if: success()
        run: |
          cp coverage/coverage-summary.json pr-coverage-summary.json || echo "PR coverage missing"


  dev-tests:
    name: Development Coverage Job
    needs: pr-tests
    runs-on: ubuntu-latest
    if: ${{ github.base_ref == 'development' }}
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.COMMON_TOKEN }}
          submodules: recursive
          fetch-depth: 0

      - name: Checkout development
        run: git checkout development

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: npm

      - name: Configure npm private registry
        run: |
          echo "@habuildserver:registry=https://npm.pkg.github.com/" >> ~/.npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.SDK_TOKEN }}" >> ~/.npmrc

      - run: npm ci
      - run: npm run test:cov || echo "Dev coverage run failed (ignored)"

      - name: Save Dev coverage
        run: |
          cp coverage/coverage-summary.json dev-coverage-summary.json || echo "Dev coverage missing"


  report:
    name: Coverage Report Merge
    needs: [pr-tests, dev-tests]
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Copy coverage results from PR job
        uses: actions/download-artifact@v4
        if: exists('pr-coverage-summary.json')
        with:
          name: pr-coverage
          path: .

      - name: Parse coverage safely
        run: |
          PR=$(jq '.total.lines.pct' pr-coverage-summary.json 2>/dev/null || echo "N/A")

          if [ -f dev-coverage-summary.json ]; then
            DEV=$(jq '.total.lines.pct' dev-coverage-summary.json)
            COMPARE="Development Coverage: ${DEV}%"
          else
            COMPARE="Development coverage unavailable"
          fi

          echo "### ðŸ“Š Coverage Report
          **PR Coverage:** ${PR}%
          ${COMPARE}

          ---
          _CI auto-generated report_" > comment.md

      - name: Post PR comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('comment.md', 'utf8');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const previous = comments.find(c =>
              c.user.login === "github-actions[bot]" &&
              c.body.includes("Coverage Report")
            );

            if (previous) {
              github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: previous.id,
                body
              });
            } else {
              github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }

      # ---- Codecov (never fail CI) ----
      - name: Upload to Codecov
        continue-on-error: true
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: unittests
          name: ${{ inputs.service-name }}
          files: pr-coverage-summary.json
          fail_ci_if_error: false
          verbose: true
