name: Reusable - Development PR Comprehensive Checks

on:
  workflow_call:
    inputs:
      node-version:
        description: "Node.js version"
        required: false
        default: "22"
        type: string

      service-name:
        description: "Service name for Codecov flag"
        required: true
        type: string

    secrets:
      SDK_TOKEN:
        required: true
      CODECOV_TOKEN:
        required: true
      COMMON_TOKEN:
        required: true

jobs:
  prepare:
    name: Checkout + Install
    runs-on: ubuntu-latest

    outputs:
      cache-hit: ${{ steps.cache-node.outputs.cache-hit }}

    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.COMMON_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: "npm"

      - name: Configure npm private registry
        run: |
          echo "@habuildserver:registry=https://npm.pkg.github.com/" >> ~/.npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.SDK_TOKEN }}" >> ~/.npmrc

      - name: Install dependencies
        run: npm ci

      - name: Cache node_modules
        id: cache-node
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-${{ inputs.node-version }}-${{ hashFiles('package-lock.json') }}


  lint:
    name: Lint & Prettier
    runs-on: ubuntu-latest
    needs: prepare

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore node_modules
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-${{ inputs.node-version }}-${{ hashFiles('package-lock.json') }}

      - name: Run ESLint (full repo)
        run: npm run lint:check

      - name: Check Prettier formatting
        run: |
          npm run format
          if ! git diff --quiet; then
            echo "âŒ Code not formatted. Run npm run format."
            git diff
            exit 1
          fi
          echo "âœ… Formatting OK"


  pr-tests:
    name: PR Coverage
    runs-on: ubuntu-latest
    needs: prepare

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore node_modules
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-${{ inputs.node-version }}-${{ hashFiles('package-lock.json') }}

      - name: Run test coverage
        run: npm run test:cov

      - name: Copy PR summary
        run: cp coverage/coverage-summary.json pr-summary.json

      - uses: actions/upload-artifact@v4
        with:
          name: pr-coverage
          path: pr-summary.json


  dev-tests:
    name: Development Coverage
    runs-on: ubuntu-latest
    needs: prepare
    continue-on-error: true  # allow failures

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: development

      - name: Restore node_modules
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-${{ inputs.node-version }}-${{ hashFiles('package-lock.json') }}

      - name: Run test coverage
        run: npm run test:cov

      - name: Copy dev summary
        if: always()
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            cp coverage/coverage-summary.json dev-summary.json
          else
            echo "{}" > dev-summary.json
          fi

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dev-coverage
          path: dev-summary.json


  report:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: [pr-tests, dev-tests]

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: pr-coverage
          path: reports

      - uses: actions/download-artifact@v4
        with:
          name: dev-coverage
          path: reports
        continue-on-error: true

      - name: Generate Markdown Table
        id: md
        run: |
          # --- PR Coverage ---
          PR_LINES=$(jq '.total.lines.pct' reports/pr-summary.json)
          PR_STMTS=$(jq '.total.statements.pct' reports/pr-summary.json)
          PR_FUNCS=$(jq '.total.functions.pct' reports/pr-summary.json)
          PR_BRANCHES=$(jq '.total.branches.pct' reports/pr-summary.json)

          # --- Dev Coverage ---
          if [ -f reports/dev-summary.json ]; then
            DEV_LINES=$(jq '.total.lines.pct // "N/A"' reports/dev-summary.json)
            DEV_STMTS=$(jq '.total.statements.pct // "N/A"' reports/dev-summary.json)
            DEV_FUNCS=$(jq '.total.functions.pct // "N/A"' reports/dev-summary.json)
            DEV_BRANCHES=$(jq '.total.branches.pct // "N/A"' reports/dev-summary.json)
          else
            DEV_LINES="N/A"
            DEV_STMTS="N/A"
            DEV_FUNCS="N/A"
            DEV_BRANCHES="N/A"
          fi

          echo "
          ### ðŸ“Š Coverage Report

          | Metric     | PR (%)        | Development (%) |
          |------------|---------------|------------------|
          | Lines      | ${PR_LINES}%  | ${DEV_LINES}%    |
          | Statements | ${PR_STMTS}%  | ${DEV_STMTS}%    |
          | Functions  | ${PR_FUNCS}%  | ${DEV_FUNCS}%    |
          | Branches   | ${PR_BRANCHES}% | ${DEV_BRANCHES}% |

          ---

          _CI auto-generated report_
          " > comment.md

      - name: Post PR Comment
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require("fs");
            const body = fs.readFileSync("comment.md", "utf8");

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const existing = comments.find(c =>
              c.user.login === "github-actions[bot]" &&
              c.body.includes("Coverage Report")
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }

      - name: Upload to Codecov (non-blocking)
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: reports/pr-summary.json
          flags: unittests
          name: ${{ inputs['service-name'] }}
          fail_ci_if_error: false
          verbose: true
