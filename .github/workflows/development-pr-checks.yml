name: Reusable - Development PR Comprehensive Checks

on:
  workflow_call:
    inputs:
      node-version:
        default: "22"
        type: string
      service-name:
        required: true
        type: string
    secrets:
      SDK_TOKEN:
        required: true
      CODECOV_TOKEN:
        required: true
      COMMON_TOKEN:
        required: true

jobs:

  # ===========================================================
  # 1) LINT + FORMAT CHECK (always first)
  # ===========================================================
  lint_format:
    name: Lint & Format
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.COMMON_TOKEN }}
          fetch-depth: 0
          submodules: recursive
          ref: ${{ github.event.pull_request.head.sha }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: npm

      - name: Private npm auth
        run: |
          echo "@habuildserver:registry=https://npm.pkg.github.com/" >> ~/.npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.SDK_TOKEN }}" >> ~/.npmrc

      - run: npm ci

      - name: Run ESLint
        run: npm run lint:check

      - name: Run Prettier
        run: |
          npm run format
          if ! git diff --quiet; then
            echo "âŒ Code not formatted. Run npm run format locally."
            exit 1
          fi

  # ===========================================================
  # 2) PR COVERAGE â€“ runs PR tests
  # ===========================================================
  pr_coverage:
    name: PR Coverage
    runs-on: ubuntu-latest
    needs: lint_format
    outputs:
      pr_ok: ${{ steps.save.outputs.ok }}

    steps:
      - name: Checkout PR branch (correct way for reusable)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.COMMON_TOKEN }}
          fetch-depth: 0
          submodules: recursive
          ref: ${{ github.event.pull_request.head.sha }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: npm

      - run: npm ci

      - name: Run PR tests
        run: npm run test:cov

      - name: Save PR coverage
        id: save
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            cp coverage/coverage-summary.json pr-coverage-summary.json
            echo "ok=true" >> $GITHUB_OUTPUT
          else
            echo "ok=false" >> $GITHUB_OUTPUT
            ls -R .
            exit 1
          fi

      - name: Upload PR â†’ Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: pr-coverage-summary.json
          flags: pr-tests
          name: ${{ inputs.service-name }}-pr

  # ===========================================================
  # 3) DEVELOPMENT COVERAGE â€“ ONLY IF BASE IS DEVELOPMENT
  # ===========================================================
  dev_coverage:
    name: Development Coverage
    runs-on: ubuntu-latest
    needs: lint_format
    if: github.base_ref == 'development'

    steps:
      - name: Checkout development
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.COMMON_TOKEN }}
          fetch-depth: 0
          submodules: recursive
          ref: development

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: npm

      - run: npm ci

      - name: Run development tests
        run: npm run test:cov

      - name: Save dev coverage
        run: cp coverage/coverage-summary.json dev-coverage-summary.json

      - name: Upload DEV â†’ Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: dev-coverage-summary.json
          flags: dev-tests
          name: ${{ inputs.service-name }}-dev

  # ===========================================================
  # 4) COMPARE RESULTS (runs after both coverage jobs)
  # ===========================================================
  compare:
    name: Compare PR vs Development
    runs-on: ubuntu-latest
    needs: [pr_coverage, dev_coverage]
    if: needs.pr_coverage.outputs.pr_ok == 'true'

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - run: sudo apt-get install -y jq

      - name: Write comparison comment
        run: |
          PR=$(jq '.total.lines.pct' pr-coverage-summary.json)

          if [ -f dev-coverage-summary.json ]; then
            DEV=$(jq '.total.lines.pct' dev-coverage-summary.json)
            COMPARE="Development: ${DEV}%"
          else
            COMPARE="Development coverage unavailable"
          fi

          echo "### ðŸ“Š Coverage Report
          **PR Coverage:** ${PR}%

          ${COMPARE}

          ---
          _CI auto-generated report_" > comment.md

      - name: Comment on PR
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs')
            const body = fs.readFileSync('comment.md', 'utf8')
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            })
