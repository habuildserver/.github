name: Reusable - Development PR Comprehensive Checks

on:
  workflow_call:
    inputs:
      node-version:
        description: "Node.js version"
        required: false
        default: "22"
        type: string
      service-name:
        description: "Service name for Codecov flag"
        required: true
        type: string
    secrets:
      SDK_TOKEN:
        required: true
      CODECOV_TOKEN:
        required: true
      COMMON_TOKEN:
        required: true

jobs:
  lint-test-coverage:
    name: ESLint, Format & Test Coverage Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write

    steps:
      # -------------------------
      # CHECKOUT WITH SUBMODULE
      # -------------------------
      - name: Checkout code (with submodules)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.COMMON_TOKEN }}

      # -------------------------
      # NODE SETUP
      # -------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: "npm"

      # -------------------------
      # PRIVATE NPM AUTH
      # -------------------------
      - name: Configure npm for private packages
        run: |
          echo "@habuildserver:registry=https://npm.pkg.github.com/" >> ~/.npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.SDK_TOKEN }}" >> ~/.npmrc

      # -------------------------
      # INSTALL DEPENDENCIES
      # -------------------------
      - name: Install dependencies
        run: npm ci

      # -------------------------
      # LINTING
      # -------------------------
      - name: Run linting
        run: npm run lint:check

      # -------------------------
      # FORMAT CHECK
      # -------------------------
      - name: Check code formatting
        run: |
          npm run format
          if ! git diff --quiet; then
            echo "‚ùå Code is not properly formatted."
            exit 1
          fi

      # -------------------------
      # RUN PR TEST COVERAGE
      # -------------------------
      - name: Run PR tests with coverage
        id: test-pr
        run: npm run test:cov

      # -----------------------------------
      # SAVE PR COVERAGE REPORT
      # -----------------------------------
      - name: Store PR coverage summary
        run: |
          mkdir -p reports
          cp coverage/coverage-summary.json reports/pr-coverage-summary.json

      # -----------------------------------
      # RUN DEV BRANCH TEST COVERAGE
      # -----------------------------------
      - name: Run development branch tests
        id: dev-tests
        if: github.base_ref == 'development'
        run: |
          git checkout development
          npm ci
          npm run test:cov
          cp coverage/coverage-summary.json reports/dev-coverage-summary.json
          git checkout -
        continue-on-error: true

      # -----------------------------------
      # GENERATE FINAL FULL REPORT
      # (Screenshot #1 style)
      # -----------------------------------
      - name: Generate Full Coverage Report
        id: coverage-report
        run: |
          PR="reports/pr-coverage-summary.json"
          DEV="reports/dev-coverage-summary.json"

          if [ ! -f "$PR" ]; then
            echo "Coverage summary not found!"
            exit 1
          fi

          # PR metrics
          PR_LINES=$(jq '.total.lines.pct' $PR)
          PR_STMTS=$(jq '.total.statements.pct' $PR)
          PR_FUNCS=$(jq '.total.functions.pct' $PR)
          PR_BRANCHES=$(jq '.total.branches.pct' $PR)

          # Threshold
          THRESHOLD=80
          BELOW=$(echo "$PR_LINES < $THRESHOLD" | bc)

          STATUS=""
          if [ "$BELOW" -eq 1 ]; then
            STATUS="‚ö†Ô∏è WARNING"
            THRESHOLD_MSG="‚ö†Ô∏è **Please note:** The current coverage is below the ${THRESHOLD}% threshold."
          else
            STATUS="‚úÖ PASSED"
            THRESHOLD_MSG=""
          fi

          # Development metrics
          if [ -f "$DEV" ]; then
            DEV_LINES=$(jq '.total.lines.pct' $DEV)
            DEV_STMTS=$(jq '.total.statements.pct' $DEV)
            DEV_FUNCS=$(jq '.total.functions.pct' $DEV)
            DEV_BRANCHES=$(jq '.total.branches.pct' $DEV)

            COMPARISON_TABLE="
            | Category | PR Percentage | Base Branch |
            | --- | ---: | ---: |
            | Lines | ${PR_LINES}% | ${DEV_LINES}% |
            | Statements | ${PR_STMTS}% | ${DEV_STMTS}% |
            | Functions | ${PR_FUNCS}% | ${DEV_FUNCS}% |
            | Branches | ${PR_BRANCHES}% | ${DEV_BRANCHES}% |
            "

            COMP_MSG="Comparison with \`development\`:"
            COMP_SUB="‚úîÔ∏è Coverage met or exceeded base branch on all metrics."

          else
            COMPARISON_TABLE="
            | Category | PR Percentage |
            | --- | ---: |
            | Lines | ${PR_LINES}% |
            | Statements | ${PR_STMTS}% |
            | Functions | ${PR_FUNCS}% |
            | Branches | ${PR_BRANCHES}% |
            "

            COMP_MSG="‚ÑπÔ∏è Development coverage not available"
            COMP_SUB=""
          fi

          # Final message
          echo "---
          ### üìä CI Coverage Report

          **Status:** ${STATUS}

          ${THRESHOLD_MSG}

          ${COMP_MSG}  
          ${COMP_SUB}

          ${COMPARISON_TABLE}

          ---

          *This is a CI-generated report for total project coverage. Data is also being sent to Codecov.*" > coverage-comment.md

      # -----------------------------------
      # POST COMMENT TO PR (AUTO-UPDATE)
      # -----------------------------------
      - name: Post Coverage Comment to PR
        uses: actions/github-script@v6
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('coverage-comment.md', 'utf8');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(
              c => c.user.login === 'github-actions[bot]' &&
                   c.body.includes('CI Coverage Report')
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

      # -----------------------------------
      # CODECOV UPLOAD (NON BLOCKING)
      # -----------------------------------
      - name: Upload to Codecov (does not fail CI)
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: coverage/lcov.info
          flags: unittests
          name: ${{ inputs.service-name }}
          verbose: true
        continue-on-error: true
