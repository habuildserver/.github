name: Reusable - Development PR Comprehensive Checks

on:
  workflow_call:
    inputs:
      node-version:
        type: string
        default: "22"
      service-name:
        type: string
        required: true
    secrets:
      SDK_TOKEN:
        required: true
      CODECOV_TOKEN:
        required: true
      COMMON_TOKEN:
        required: true

jobs:
  setup-env:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.changed-files.outputs.changed }}
      files: ${{ steps.changed-files.outputs.files }}

    steps:
      - name: Checkout with submodules
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.COMMON_TOKEN }}
          fetch-depth: 0
          submodules: recursive

      - name: Debug common folder
        run: ls -R src/app/common || echo "No common folder found"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: npm

      - name: Configure npm private registry
        run: |
          echo "@habuildserver:registry=https://npm.pkg.github.com/" >> ~/.npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.SDK_TOKEN }}" >> ~/.npmrc

      - name: Install deps
        run: npm ci

      - name: Find changed TypeScript files
        id: changed-files
        run: |
          FILES=$(git diff --name-only origin/${{ github.base_ref }} HEAD -- '*.ts')
          echo "files=$FILES" >> $GITHUB_OUTPUT
          [ -z "$FILES" ] && echo "changed=false" >> $GITHUB_OUTPUT || echo "changed=true" >> $GITHUB_OUTPUT

  lint:
    needs: setup-env
    runs-on: ubuntu-latest
    if: needs.setup-env.outputs.changed == 'true'

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.COMMON_TOKEN }}
          fetch-depth: 0
          submodules: recursive

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: npm

      - run: npm ci

      - name: Lint changed files only
        run: |
          echo "Linting only changed files:"
          echo "${{ needs.setup-env.outputs.files }}"
          npx eslint ${{ needs.setup-env.outputs.files }} --fix

  formatting:
    needs: setup-env
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.COMMON_TOKEN }}
          fetch-depth: 0
          submodules: recursive

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: npm

      - run: npm ci

      - name: Format only changed files
        run: |
          FILES="${{ needs.setup-env.outputs.files }}"
          if [ -z "$FILES" ]; then
            echo "No TS files changed. Skipping formatting."
            exit 0
          fi

          echo "$FILES" | xargs prettier --write

      - name: Ensure no formatting differences
        run: |
          if ! git diff --quiet; then
            echo "‚ùå Some files are not formatted properly."
            git diff
            exit 1
          fi

  test-pr:
    needs: setup-env
    runs-on: ubuntu-latest
    outputs:
      summary-exists: ${{ steps.check-summary.outputs.exists }}

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.COMMON_TOKEN }}
          fetch-depth: 0
          submodules: recursive

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: npm

      - run: npm ci

      - name: Run PR tests w/ coverage
        run: npm run test:cov

      - name: Check coverage summary exists
        id: check-summary
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            mv coverage/coverage-summary.json pr-coverage-summary.json
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚ùå Missing coverage-summary.json!"
            exit 1
          fi

  test-dev:
    needs: test-pr
    runs-on: ubuntu-latest
    if: github.base_ref == 'development'

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.COMMON_TOKEN }}
          fetch-depth: 0
          submodules: recursive

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: npm

      - run: npm ci

      - name: Run tests on development branch
        run: |
          git checkout development
          npm ci
          npm run test:cov
          mv coverage/coverage-summary.json dev-coverage-summary.json

  analyze-coverage:
    needs: [test-pr, test-dev]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Parse + Create Comment
        run: |
          node <<'EOF'
          const fs = require("fs");

          const pr = JSON.parse(fs.readFileSync("pr-coverage-summary.json", "utf8")).total;
          let dev = null;

          if (fs.existsSync("dev-coverage-summary.json")) {
            dev = JSON.parse(fs.readFileSync("dev-coverage-summary.json", "utf8")).total;
          }

          const pct = pr.lines.pct;

          const body = `
          ### üìä Coverage Report
          **PR Coverage:** ${pct}%

          ${dev ? `Comparison with development:
          - Dev coverage: ${dev.lines.pct}%` : "No dev coverage to compare"}

          ---

          *CI Generated Report*
          `;

          fs.writeFileSync("comment.md", body);
          EOF

      - name: Comment on PR
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs')
            const body = fs.readFileSync('comment.md', 'utf8')

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            })

  upload-codecov:
    needs: test-pr
    runs-on: ubuntu-latest
    if: needs.test-pr.outputs.summary-exists == 'true'

    steps:
      - uses: actions/checkout@v4

      - uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: pr-coverage-summary.json
          flags: unittests
          name: ${{ inputs.service-name }}
          fail_ci_if_error: true
