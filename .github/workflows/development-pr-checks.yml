name: Reusable - Development PR Comprehensive Checks

on:
  workflow_call:
    inputs:
      node-version:
        required: false
        default: "22"
        type: string
      service-name:
        required: true
        type: string
    secrets:
      SDK_TOKEN:
        required: true
      CODECOV_TOKEN:
        required: true
      COMMON_TOKEN:
        required: true

jobs:
  # ================================
  # PR COVERAGE JOB
  # ================================
  pr-tests:
    name: PR Tests + Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.COMMON_TOKEN }}
          submodules: recursive
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: "npm"

      - name: Configure npm
        run: |
          echo "@habuildserver:registry=https://npm.pkg.github.com/" >> ~/.npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.SDK_TOKEN }}" >> ~/.npmrc

      # ---------------- LINT ONLY CHANGED FILES ----------------
      - name: Get TS diff
        id: diff
        continue-on-error: true
        run: |
          FILES=$(git diff --name-only origin/${{ github.base_ref }} HEAD -- '*.ts' '*.tsx' || true)
          echo "FILES=${FILES}"
          echo "files=${FILES}" >> $GITHUB_OUTPUT
          if [[ -z "$FILES" ]]; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Lint only changed files
        if: steps.diff.outputs.changed == 'true'
        run: |
          echo "Linting: ${{ steps.diff.outputs.files }}"
          npx eslint ${{ steps.diff.outputs.files }} --fix || true

      - name: Full lint fallback (no diff)
        if: steps.diff.outputs.changed == 'false'
        run: npm run lint:check || true

      # ---------------- FORMAT (skip common) ----------------
      - name: Run Prettier (skip common)
        run: |
          prettier --write "src/**/*.{ts,js}" "!src/app/common/**"

      - name: Fail if formatting required
        run: |
          if ! git diff --quiet; then
            echo "âŒ Code formatting required."
            git diff
            exit 1
          fi

      # ---------------- PR TESTS ----------------
      - name: Install dependencies
        run: npm ci

      - name: PR Coverage
        run: npm run test:cov

      - name: Copy PR coverage summary
        run: cp coverage/coverage-summary.json pr-summary.json

      - name: Upload PR artifact
        uses: actions/upload-artifact@v4
        with:
          name: pr-coverage
          path: pr-summary.json

  # ================================
  # DEV BRANCH COVERAGE (PARALLEL)
  # ================================
  dev-tests:
    name: Development Coverage
    runs-on: ubuntu-latest
    continue-on-error: true  # DEV failures should not break CI

    steps:
      - name: Checkout development branch
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.COMMON_TOKEN }}
          submodules: recursive
          fetch-depth: 0
          ref: development

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: "npm"

      - name: Configure npm
        run: |
          echo "@habuildserver:registry=https://npm.pkg.github.com/" >> ~/.npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.SDK_TOKEN }}" >> ~/.npmrc

      - name: Install dependencies
        run: npm ci

      - name: Dev coverage
        run: npm run test:cov || true

      - name: Copy development summary
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            cp coverage/coverage-summary.json dev-summary.json
          fi

      - name: Upload dev artifact
        uses: actions/upload-artifact@v4
        with:
          name: dev-coverage
          path: dev-summary.json
        continue-on-error: true

  # ================================
  # MERGE COVERAGE + COMMENT
  # ================================
  report:
    name: Merge & Report
    runs-on: ubuntu-latest
    needs: [pr-tests, dev-tests]

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: pr-coverage
          path: reports

      - uses: actions/download-artifact@v4
        with:
          name: dev-coverage
          path: reports
        continue-on-error: true

      - name: Generate Markdown Report
        id: md
        run: |
          PR=$(jq '.total.lines.pct' reports/pr-summary.json)

          if [ -f reports/dev-summary.json ]; then
            DEV=$(jq '.total.lines.pct' reports/dev-summary.json)
            COMPARE="| Lines | ${PR}% | ${DEV}% |"
          else
            COMPARE="| Lines | ${PR}% | N/A |"
          fi

          echo "### ðŸ“Š Coverage Report  
          **PR Coverage:** ${PR}%  

          | Metric | PR | Development |  
          |-------|-----|-------------|  
          ${COMPARE}  

          ---  
          _CI auto-generated report_  
          " > comment.md

      - name: Post GitHub Comment
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs')
            const body = fs.readFileSync('comment.md','utf8')

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            })

            const old = comments.find(c => c.user.login === "github-actions[bot]" && c.body.includes("Coverage Report"))

            if (old) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: old.id,
                body,
              })
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              })
            }

      # ---- Codecov Upload (Non-blocking) ----
      - name: Upload to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: reports/pr-summary.json
          flags: unittests
          name: ${{ inputs.service-name }}
          fail_ci_if_error: false
          verbose: true
