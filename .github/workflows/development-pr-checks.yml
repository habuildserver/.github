name: Reusable - Development PR Comprehensive Checks

on:
  workflow_call:
    inputs:
      node-version:
        description: "Node.js version"
        required: false
        default: "22"
        type: string
      service-name:
        description: "Service name for Codecov flag"
        required: true
        type: string

    secrets:
      SDK_TOKEN:
        required: true
      CODECOV_TOKEN:
        required: true
      COMMON_TOKEN:
        required: false

jobs:
  # ======================================================
  # 1ï¸âƒ£ Checkout + Install + Lint + Format
  # ======================================================
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.COMMON_TOKEN || secrets.GITHUB_TOKEN }}
          submodules: recursive
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: npm

      - name: Configure npm for private packages
        run: |
          echo "@habuildserver:registry=https://npm.pkg.github.com/" >> ~/.npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.SDK_TOKEN }}" >> ~/.npmrc

      - name: Install dependencies
        run: npm ci

      - name: Run lint (ignore common folder)
        run: |
          npx eslint "./src/**/*.ts" --ignore-pattern "src/app/common/**"
      
      - name: Run prettier check
        run: |
          npx prettier --write "src/**/*.{ts,js}" --ignore-path .prettierignore
          if ! git diff --quiet; then
            echo "âŒ Formatting issues found"
            git diff
            exit 1
          fi


  # ======================================================
  # 2ï¸âƒ£ Run PR coverage
  # ======================================================
  pr-tests:
    name: PR Test Coverage
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: recursive
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Run test coverage
        run: npm run test:cov

      - name: Move PR coverage to root
        run: |
          cp coverage/coverage-summary.json pr-coverage-summary.json
          cp coverage/lcov.info pr-lcov.info

      - name: Upload PR coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: pr-coverage
          path: |
            pr-coverage-summary.json
            pr-lcov.info


  # ======================================================
  # 3ï¸âƒ£ Run Development coverage in parallel
  # ======================================================
  dev-tests:
    name: Development Branch Coverage
    runs-on: ubuntu-latest
    if: github.base_ref == 'development'
    needs: lint

    steps:
      - uses: actions/checkout@v4

      - name: Fetch development branch
        run: |
          git fetch origin development
          git checkout development

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Run test coverage
        run: npm run test:cov

      - name: Move DEV coverage to root
        run: |
          cp coverage/coverage-summary.json dev-coverage-summary.json

      - name: Upload DEV coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: dev-coverage
          path: dev-coverage-summary.json


  # ======================================================
  # 4ï¸âƒ£ Final coverage report (Comparison Table)
  # ======================================================
  report:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: [pr-tests, dev-tests]

    permissions:
      pull-requests: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Download PR artifact
        uses: actions/download-artifact@v4
        with:
          name: pr-coverage
          path: .

      - name: Download DEV artifact (safe)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: dev-coverage
          path: .

      - name: Generate Coverage Report Markdown
        run: |
          PR=$(jq '.total.lines.pct' pr-coverage-summary.json 2>/dev/null || echo "N/A")

          if [ -f dev-coverage-summary.json ]; then
            DEV=$(jq '.total.lines.pct' dev-coverage-summary.json)
          else
            DEV="N/A"
          fi

          echo "### ðŸ“Š Combined Coverage Report

          | Metric | PR Branch | Development |
          |-------|----------:|------------:|
          | **Lines** | ${PR}% | ${DEV}% |

          ---

          _Auto-generated CI report_
          " > comment.md


      - name: Post PR comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('comment.md', 'utf8');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const existing = comments.find(c =>
              c.user.login === "github-actions[bot]" &&
              c.body.includes("Combined Coverage Report")
            );

            if (existing) {
              github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body
              });
            } else {
              github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }

      - name: Upload PR coverage to Codecov (non-blocking)
        continue-on-error: true
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: pr-lcov.info
          flags: unittests
          fail_ci_if_error: false
          verbose: true
          name: ${{ inputs.service-name }}
