name: Reusable - Development PR Coverage Checks

on:
  workflow_call:
    inputs:
      node-version:
        default: "22"
        type: string
      service-name:
        required: true
        type: string
    secrets:
      SDK_TOKEN:
        required: true
      CODECOV_TOKEN:
        required: true
      COMMON_TOKEN:
        required: true

jobs:
  test-pr:
    name: Test (PR) Coverage
    runs-on: ubuntu-latest
    outputs:
      pr-summary: ${{ steps.save.outputs.exists }}

    steps:
      - name: Checkout code (with submodules)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.COMMON_TOKEN }}
          fetch-depth: 0
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: npm

      - name: Configure npm for private packages
        run: |
          echo "@habuildserver:registry=https://npm.pkg.github.com/" >> ~/.npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.SDK_TOKEN }}" >> ~/.npmrc

      - name: Install dependencies
        run: npm ci

      - name: Run PR tests
        run: npm run test:cov

      - name: Save PR coverage summary
        id: save
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            mv coverage/coverage-summary.json pr-coverage-summary.json
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âŒ PR coverage-summary.json not found"
            exit 1
          fi

  test-dev:
    name: Test (Development) Coverage
    needs: test-pr
    runs-on: ubuntu-latest
    if: github.base_ref == 'development'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.COMMON_TOKEN }}
          fetch-depth: 0
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: npm

      - run: npm ci

      - name: Run dev branch tests
        run: |
          git checkout development
          npm ci
          npm run test:cov
          mv coverage/coverage-summary.json dev-coverage-summary.json

  analyze:
    name: Compare Coverage + Comment
    needs: [test-pr, test-dev]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Generate coverage comment
        run: |
          PR=$(jq '.total.lines.pct' pr-coverage-summary.json)
          if [ -f dev-coverage-summary.json ]; then
            DEV=$(jq '.total.lines.pct' dev-coverage-summary.json)
            COMPARE="Development coverage: ${DEV}%"
          else
            COMPARE="No development coverage available"
          fi

          echo "### ðŸ“Š Coverage Report
          **PR Coverage:** ${PR}%

          ${COMPARE}

          ---
          _CI auto-generated report_" > comment.md

      - name: Post comment on PR
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs')
            const body = fs.readFileSync('comment.md', 'utf8')

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            })

  upload-codecov:
    name: Upload Coverage to Codecov
    needs: test-pr
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: pr-coverage-summary.json
          flags: unittests
          name: ${{ inputs.service-name }}
          fail_ci_if_error: true
