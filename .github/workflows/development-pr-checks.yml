name: Development PR Comprehensive Checks

on:
  pull_request:
    branches: [development]
  push:
    branches: [development, staging, main]

jobs:

  #############################################
  # JOB A ‚Äî PR Lint + Tests (with coverage)
  #############################################
  pr-tests:
    name: PR Lint + Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout code (with submodules)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.COMMON_TOKEN }}
          submodules: recursive
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Configure npm for private packages
        run: |
          echo "@habuildserver:registry=https://npm.pkg.github.com/" >> ~/.npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.SDK_TOKEN }}" >> ~/.npmrc

      - name: Install dependencies
        run: npm ci

      # LINT
      - name: Run linting
        run: npm run lint:check

      # FORMAT
      - name: Check formatting
        run: |
          npm run format
          git diff --quiet || (echo "‚ùå Formatting issues found"; exit 1)

      # COVERAGE
      - name: Run PR tests with coverage
        run: npm run test:cov

      # SAVE COVERAGE
      - name: Save PR coverage
        run: |
          mkdir -p reports
          cp coverage/coverage-summary.json reports/pr.json

      - uses: actions/upload-artifact@v4
        with:
          name: pr-coverage
          path: reports/pr.json


  #############################################
  # JOB B ‚Äî Development Coverage (Fully Non-blocking)
  #############################################
  dev-tests:
    name: Development Coverage (non-blocking)
    runs-on: ubuntu-latest
    if: github.base_ref == 'development'
    continue-on-error: true   # <-- entire job never fails

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        continue-on-error: true   # ignore checkout failures

      - name: Switch to development branch
        run: git checkout development
        continue-on-error: true   # ignore branch switch failures

      - name: Install deps
        run: npm ci
        continue-on-error: true   # ignore installation failures

      - name: Run dev tests with coverage
        run: npm run test:cov
        continue-on-error: true   # ignore test failures

      - name: Save dev coverage if exists
        run: |
          mkdir -p reports
          if [ -f coverage/coverage-summary.json ]; then
            cp coverage/coverage-summary.json reports/dev.json
            echo "Dev coverage found"
          else
            echo "No dev coverage found"
          fi
        continue-on-error: true

      - uses: actions/upload-artifact@v4
        with:
          name: dev-coverage
          path: reports/dev.json
          if-no-files-found: ignore
        continue-on-error: true


  #############################################
  # JOB C ‚Äî Coverage Report (Final combined comment)
  #############################################
  coverage-report:
    name: Combine PR + Development Coverage
    runs-on: ubuntu-latest
    needs:
      - pr-tests
      - dev-tests
    permissions:
      pull-requests: write
      contents: read

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: pr-coverage
          path: reports

      - uses: actions/download-artifact@v4
        with:
          name: dev-coverage
          path: reports
          continue-on-error: true

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Generate combined report
        run: |
          PR=reports/pr.json
          DEV=reports/dev.json

          PR_LINES=$(jq '.total.lines.pct' $PR)
          PR_STATEMENTS=$(jq '.total.statements.pct' $PR)
          PR_FUNCS=$(jq '.total.functions.pct' $PR)
          PR_BRANCHES=$(jq '.total.branches.pct' $PR)

          if [ -f "$DEV" ]; then
            DEV_LINES=$(jq '.total.lines.pct' $DEV)
            DEV_STATEMENTS=$(jq '.total.statements.pct' $DEV)
            DEV_FUNCS=$(jq '.total.functions.pct' $DEV)
            DEV_BRANCHES=$(jq '.total.branches.pct' $DEV)

            TABLE="| Category | PR Branch | Development |
            | --- | ---: | ---: |
            | Lines | ${PR_LINES}% | ${DEV_LINES}% |
            | Statements | ${PR_STATEMENTS}% | ${DEV_STATEMENTS}% |
            | Functions | ${PR_FUNCS}% | ${DEV_FUNCS}% |
            | Branches | ${PR_BRANCHES}% | ${DEV_BRANCHES}% |"

                      else
                        TABLE="| Category | PR Branch |
            | --- | ---: |
            | Lines | ${PR_LINES}% |
            | Statements | ${PR_STATEMENTS}% |
            | Functions | ${PR_FUNCS}% |
            | Branches | ${PR_BRANCHES}% |

            ‚ÑπÔ∏è Dev coverage unavailable"
                      fi

                      echo "### üìä Combined Coverage Report

            ${TABLE}

            _Auto-generated CI report_" > coverage-comment.md

      - name: Post PR Comment
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('coverage-comment.md','utf8');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            })


  #############################################
  # JOB D ‚Äî Codecov Upload (Optional / Non-blocking)
  #############################################
  codecov:
    name: Codecov Upload
    runs-on: ubuntu-latest
    needs: pr-tests
    continue-on-error: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: pr-coverage
          path: reports

      - uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: reports/pr.json
          flags: unittests
          fail_ci_if_error: false
          verbose: true
